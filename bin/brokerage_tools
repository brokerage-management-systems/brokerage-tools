#!/usr/bin/env ruby

$:.unshift File.join(File.dirname(__FILE__), *%w[.. lib])

help = <<HELP
Brokerage Tools is a report parsing tool.

Basic Command Line Usage:
  brokerage_tools [OPTIONS]

Options:
HELP

require 'rubygems'
require 'optparse'
require 'brokerage_tools'
require 'brokerage_tools/app'

options = { :appconfig => "#{ Dir.pwd }#{ File::SEPARATOR }application.yml", :dbconfig => "#{ Dir.pwd }#{ File::SEPARATOR }database.yml", :emailconfig => "#{ Dir.pwd }#{ File::SEPARATOR }email.yml" }

opts = OptionParser.new do |opts|
  opts.banner = help

  opts.on('-a', '--appconfig [FILE]', 'Application configuration file [Optional], defaults to application.yml') do |file|
    options[:appconfig] = file
  end

  opts.on('-d', '--dbconfig [FILE]', 'Database configuration file [Optional], defaults to database.yml') do |file|
    options[:dbconfig] = file
  end

  opts.on('-e', '--emailconfig [FILE]', 'Email server configuration file [Optional], defaults to email.yml') do |file|
    options[:emailconfig] = file
  end

  opts.on('-p', '--parse TYPE', [:fbnr074p, :trdrevtd], 'Report types to parse: (fbnr074p, trdrevtd)') do |type|
    options[:parse] = type
  end

  opts.on('-v', '--validate TYPE', [:trdrevtd], 'Validation type: (trdrevtd)') do |type|
    options[:validate] = type
  end

  opts.on('--email-errors-to EMAIL_ADDRESS', 'Email errors to specified email address.') do |email_address|
    options[:email_errors_to] = email_address
  end

  opts.on('--email-validation-to EMAIL_ADDRESS', 'Email the validation to specified email address.') do |email_address|
    options[:email_validation_to] = email_address
  end

  opts.on('--include-zips', 'Includes any zip files in the directory in parse process.') do
    options[:zips] = true
  end

  opts.on('--no-backup', 'Disables report file backup.') do
    options[:backup] = false
  end

  opts.on('--no-records', 'Disables writing report records to the database.') do
    options[:records] = false
  end

  opts.on('--with-commission-month [Month]', 'Example \'December 2012\'.') do |commission_month|
    options[:commission_month] = commission_month
  end

  opts.on('--with-entity-id [Entity ID]', 'Example \'000\'.') do |entity_id|
    options[:entity_id] = entity_id
  end

  # TODO: May not be necessary any longer, check and remove or implement
  opts.on('--no-trailer', 'Disables writing report trailer to the database.') do
    options[:trailer] = false
  end

  opts.on_tail('-h', '--help', 'Show this message') do
    puts opts
    exit 0
  end

  opts.on_tail('--version', 'Display current version.') do
    puts "Brokerage Tools: " + BrokerageTools::VERSION
    exit 0
  end
end

# Read command line options into `options` hash
begin
  opts.parse!
rescue OptionParser::InvalidOption
  puts "brokerage_tools: #{$!.message}"
  puts "brokerage_tools: try 'brokerage_tools --help' for more information"
  exit
end

unless File.file? options[:appconfig]
  puts "File does not exist: #{ options[:appconfig] }"
  exit
end

unless File.file? options[:dbconfig]
  puts "File does not exist: #{ options[:dbconfig] }"
  exit
end

unless File.file? options[:emailconfig]
  puts "File does not exist: #{ options[:emailconfig] }"
  exit
end

BrokerageTools::App.run options
